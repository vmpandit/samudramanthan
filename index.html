<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Samudra Manthan: The Eternal Churn</title>

    <!-- External Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* --- FONTS & VARS --- */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap');

        :root {
            --glass-bg: rgba(20, 30, 48, 0.7);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shine: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);

            --color-gold: #FFD700;
            --color-blue: #4facfe;
            --color-red: #ff0844;
            --color-green: #00b09b;
            --color-purple: #a855f7;
            --color-text: #fff;

            --font-title: 'Cinzel', serif;
            --font-body: 'Lato', sans-serif;
        }

        /* --- LAYOUT --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-body);
            background: #0f2027;
            color: var(--color-text);
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- BACKGROUND --- */
        #cosmos-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
        }

        /* --- GLASS UI --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(120%);
            -webkit-backdrop-filter: blur(16px) saturate(120%);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-shine);
            box-shadow: var(--glass-shadow);
            border-radius: 24px;
            padding: 24px;
            width: 90%; max-width: 480px;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.4s ease;
            position: relative;
        }

        h1, h2, h3 { margin: 0; font-family: var(--font-title); text-align: center; }
        h1 { 
            font-size: 2.2rem; 
            background: linear-gradient(to right, #fff, #b6fbff); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 8px; text-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        h2 { font-size: 1rem; color: var(--color-gold); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 16px; opacity: 0.9; }
        p { text-align: center; line-height: 1.5; font-size: 0.95rem; margin-bottom: 20px; color: rgba(255,255,255,0.9); }

        .btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 16px; width: 100%;
            border-radius: 50px; font-size: 1rem; font-weight: 700;
            margin-bottom: 12px; cursor: pointer;
            transition: all 0.2s; backdrop-filter: blur(4px);
            position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.96); background: rgba(255,255,255,0.2); }

        .btn-primary { 
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.6), rgba(0, 242, 254, 0.6)); 
            border: 1px solid rgba(79, 172, 254, 0.5);
            box-shadow: 0 4px 15px rgba(0, 242, 254, 0.2);
        }
        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.3));
            border: 1px solid rgba(255, 215, 0, 0.5);
        }
        .btn-danger { 
            background: linear-gradient(135deg, rgba(255, 8, 68, 0.6), rgba(255, 177, 153, 0.6)); 
            border: 1px solid rgba(255, 8, 68, 0.5);
        }
        .btn-power {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 1px solid rgba(118, 75, 162, 0.5);
            box-shadow: 0 0 15px rgba(118, 75, 162, 0.4);
        }
        .btn-power:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

        input {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; color: white; text-align: center; font-size: 1.1rem; margin-bottom: 16px; outline: none;
        }

        /* --- ASSETS --- */
        .churn-container {
            width: 260px; height: 260px; margin: 20px auto; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .churn-mask {
            width: 100%; height: 100%; border-radius: 50%; overflow: hidden;
            box-shadow: 0 0 40px rgba(79, 172, 254, 0.2);
            border: 2px solid rgba(255,255,255,0.1); background: #000;
        }
        #churn-dial { width: 100%; height: 100%; object-fit: cover; will-change: transform; transition: transform 0.1s ease-out; }
        .tap-hint {
            position: absolute; font-family: var(--font-title); font-weight: bold; font-size: 2rem;
            color: rgba(255,255,255,0.2); pointer-events: none; animation: pulse 1.5s infinite;
        }

        .portrait-frame {
            width: 140px; height: 140px; border-radius: 50%; border: 3px solid var(--color-gold);
            margin: 0 auto 15px auto; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.6); background: #000;
        }
        #role-img { width: 200%; height: 100%; object-fit: cover; object-position: 0% 0%; }
        .asura-crop { object-position: 100% 0% !important; }

        .treasure-frame {
            width: 120px; height: 120px; background: rgba(0,0,0,0.3); border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.2); margin: 10px auto; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        .icon-sprite { width: 400%; height: 100%; object-fit: cover; object-position: 0% 0%; }
        .icon-amrita { object-position: 0% 0%; }
        .icon-poison { object-position: 33.33% 0%; }
        .icon-cow    { object-position: 66.66% 0%; }
        .icon-elephant { object-position: 100% 0%; }

        /* --- VOTE RESULTS --- */
        .vote-results {
            width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; max-height: 200px; overflow-y: auto;
        }
        .vote-col { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 10px; }
        .vote-col h3 { font-size: 0.8rem; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; letter-spacing: 1px; }
        .vote-item { font-size: 0.8rem; margin-bottom: 4px; display: flex; align-items: center; }
        .vote-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .dot-green { background: var(--color-green); }
        .dot-red { background: var(--color-red); }

        /* --- WAITING/THINKING UI --- */
        .thinking-area { width: 100%; margin: 10px 0; font-size: 0.9rem; color: #aaa; min-height: 20px; text-align: center; display: flex; align-items: center; justify-content: center; }
        .thinking-dot { display: inline-block; width: 6px; height: 6px; background: #fff; border-radius: 50%; margin: 0 3px; animation: pulse 0.8s infinite alternate; }

        /* --- MODAL --- */
        #story-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #story-modal.active { opacity: 1; pointer-events: auto; }
        .story-content {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border: 2px solid var(--color-gold);
            border-radius: 20px; padding: 25px; max-width: 90%; width: 400px;
            text-align: center; box-shadow: 0 0 40px rgba(255, 215, 0, 0.2);
            max-height: 80vh; overflow-y: auto;
        }
        .story-title { font-family: var(--font-title); font-size: 1.5rem; color: var(--color-gold); margin-bottom: 10px; }
        .story-text { font-size: 1rem; line-height: 1.6; color: #fff; margin-bottom: 20px; text-align: left; }
        .story-section { margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }

        /* --- UTILS --- */
        .screen { display: none; width: 100%; flex-direction: column; align-items: center; animation: fadeIn 0.5s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } 100% { opacity: 0.2; transform: scale(1); } }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 100; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap;
        }
    </style>
</head>
<body>

    <canvas id="cosmos-canvas"></canvas>

    <!-- STORY MODAL -->
    <div id="story-modal" class="active">
        <div class="story-content">
            <div class="story-title">The Legend</div>
            <div class="story-text">
                <div class="story-section">
                    <strong>Once upon a time...</strong><br>
                    Gods (Devas) and Demons (Asuras) worked together to churn the Cosmic Ocean. They wanted <strong>Amrita</strong>, the nectar of immortality!
                </div>
                <div class="story-section">
                    <strong>How to Play:</strong>
                    <ol style="padding-left: 20px; margin: 5px 0;">
                        <li><strong>Tap Fast!</strong> Help churn the mountain.</li>
                        <li><strong>Vote Wise!</strong> If good things come up (Cow, Elephant), vote <strong>Keep</strong>. If Poison comes, vote <strong>Discard</strong>!</li>
                        <li><strong>Watch Out!</strong> Some players are Secret Traitors. They want the world to break!</li>
                    </ol>
                </div>
                <div class="story-section">
                    <strong>Goal:</strong> Find the Amrita before time runs out!
                </div>
            </div>
            <button class="btn btn-primary" onclick="UI.hideStory()">Start Adventure!</button>
        </div>
    </div>

    <!-- HOME -->
    <div id="screen-home" class="screen active">
        <div class="glass-panel">
            <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.2);">
                <img src="./mount_mandara_churn.png" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'">
            </div>
            <h1>SAMUDRA</h1>
            <h2>MANTHAN</h2>
            <p>The Eternal Cosmic Churn</p>
            <button class="btn btn-primary" onclick="Game.host()">Host Multiplayer</button>
            <button class="btn btn-secondary" onclick="SinglePlayer.start()">Single Player (AI)</button>
            <button class="btn" onclick="Game.joinMenu()">Join Game</button>
            <button class="btn" style="font-size: 0.8rem; padding: 10px;" onclick="UI.showStory()">? How to Play</button>
        </div>
    </div>

    <!-- HOST LOBBY -->
    <div id="screen-host" class="screen">
        <div class="glass-panel">
            <h2>Cosmic Beacon</h2>
            <div style="background: white; padding: 10px; border-radius: 12px; margin-bottom: 10px;">
                <div id="qrcode"></div>
            </div>
            <h1 id="host-code" style="font-family: monospace; letter-spacing: 5px;">...</h1>
            <div id="player-list" style="width: 100%; max-height: 150px; overflow-y: auto; text-align: left; margin: 15px 0; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px;"></div>
            <button id="start-btn" class="btn btn-primary" disabled onclick="Host.start()">Begin Churning</button>
            <button class="btn btn-danger" onclick="location.reload()">Back</button>
        </div>
    </div>

    <!-- JOIN -->
    <div id="screen-join" class="screen">
        <div class="glass-panel">
            <h2>Enter the Void</h2>
            <input type="text" id="join-name" placeholder="Your Name (e.g. Shiva)" maxlength="12">
            <input type="text" id="join-code" placeholder="Room Code" maxlength="4" style="text-transform: uppercase;">
            <button class="btn btn-primary" onclick="Client.connect()">Connect</button>
            <button class="btn" onclick="UI.show('screen-home')">Back</button>
        </div>
    </div>

    <!-- ROLE REVEAL -->
    <div id="screen-role" class="screen">
        <div class="glass-panel">
            <h2>Your Destiny</h2>
            <div class="portrait-frame">
                <img id="role-img" src="./roles_portraits.png" onerror="this.style.display='none'">
            </div>
            <h1 id="role-name">...</h1>
            <p id="role-desc">...</p>
            <div id="role-secret" style="width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; font-size: 0.85rem; color: var(--color-gold); text-align: center;"></div>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="UI.show('screen-play')">Enter Ocean</button>
        </div>
    </div>

    <!-- GAMEPLAY -->
    <div id="screen-play" class="screen">
        <div style="position: absolute; top: 10px; left: 0; width: 100%; padding: 0 20px; display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 700; opacity: 0.8; z-index: 10;">
            <span>STABILITY <span id="stability-val" style="color: var(--color-blue);">100%</span></span>
            <span>ROUND <span id="round-val">1</span>/7</span>
        </div>

        <div class="glass-panel" style="margin-top: 50px;">
            <h2 id="phase-name" style="font-size: 1.4rem; color: #fff;">THE CHURNING</h2>
            <p id="phase-msg">Tap the mountain to churn!</p>
            <div id="game-content" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioFX = {
            ctx: null,
            init: () => { if (!AudioFX.ctx) AudioFX.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play: (type) => {
                if (!AudioFX.ctx) AudioFX.init();
                if (AudioFX.ctx.state === 'suspended') AudioFX.ctx.resume();

                const now = AudioFX.ctx.currentTime;
                const osc = AudioFX.ctx.createOscillator();
                const gain = AudioFX.ctx.createGain();
                osc.connect(gain); gain.connect(AudioFX.ctx.destination);

                if (type === 'tap') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(80, now); osc.frequency.exponentialRampToValueAtTime(30, now + 0.1);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'alert') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.15);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                    osc.start(now); osc.stop(now + 0.6);
                } else if (type === 'power') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(800, now + 0.5);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                }
            }
        };

        const UI = {
            show: (id) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },
            hideStory: () => {
                document.getElementById('story-modal').classList.remove('active');
            },
            showStory: () => {
                document.getElementById('story-modal').classList.add('active');
            },
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 3000);
            },
            getIconClass: (itemName) => {
                if(itemName.includes("Amrita")) return "icon-amrita";
                if(itemName.includes("Poison") || itemName.includes("Halahala")) return "icon-poison";
                if(itemName.includes("Cow") || itemName.includes("Kamadhenu")) return "icon-cow";
                if(itemName.includes("Elephant") || itemName.includes("Airavata")) return "icon-elephant";
                return "icon-amrita";
            }
        };

        // --- AI ENGINE ---
        const AIEngine = {
            names: ['Agni', 'Vayu', 'Varuna'],
            bots: [],
            createBots: (count) => {
                AIEngine.bots = [];
                for(let i=0; i<count; i++) {
                    AIEngine.bots.push({
                        id: 'bot_'+i, name: AIEngine.names[i % AIEngine.names.length] + ' (AI)', role: null, personality: Math.random() > 0.5 ? 'aggressive' : 'passive', powerUsed: false
                    });
                }
                return AIEngine.bots;
            },
            simulateChurn: () => {
                let totalTaps = 0;
                AIEngine.bots.forEach(bot => {
                    let botTaps = 35 + Math.floor(Math.random() * 10);
                    if(bot.role === 'Asura') botTaps -= 10;
                    totalTaps += botTaps;
                });
                return totalTaps;
            },
            simulateVote: (item, stability) => {
                let votes = {};
                AIEngine.bots.forEach(bot => {
                    let vote = true;
                    if (item.includes("Poison")) {
                        if(bot.role === 'Deva') vote = false;
                        else vote = (stability < 40); 
                    } else {
                        if(bot.role === 'Asura' && Math.random() > 0.6) vote = false;
                    }
                    votes[bot.id] = vote;
                });
                return votes;
            },
            startVotingSequence: (host) => {
                // Simulate delays for each bot
                let delay = 1000;
                const bots = host.players.filter(p => p.id.startsWith('bot_'));
                const item = host.state.phaseItem;
                const stability = host.state.stability;
                const aiVotes = AIEngine.simulateVote(item, stability);

                bots.forEach((bot, index) => {
                    setTimeout(() => {
                        host.state.votes[bot.id] = aiVotes[bot.id];
                        // Animate thinking
                        host.broadcast({ type: 'VOTE_UPDATE', msg: `${bot.name} is deciding...`, botId: bot.id });
                        setTimeout(() => {
                             host.broadcast({ type: 'VOTE_UPDATE', msg: `${bot.name} has voted.`, botId: bot.id, done: true });
                        }, 900);
                    }, delay);
                    delay += 1800 + Math.random() * 800;
                });

                // Final resolve
                setTimeout(() => {
                    host.resolveRound();
                }, delay + 1000);
            }
        };

        const SinglePlayer = {
            start: () => {
                Game.isHost = true; Game.isSinglePlayer = true;
                const human = { id: 'human', name: 'You', conn: { send: SinglePlayer.mockSend }, role: null, powerUsed: false };
                const bots = AIEngine.createBots(3).map(b => ({ ...b, conn: { send: (msg) => {} } }));
                Host.players = [human, ...bots];
                Host.init(true); Host.start();
            },
            mockSend: (data) => { setTimeout(() => Client.handleData(data), 10); },
            humanAction: (type, val) => {
                const mockConn = { peer: 'human', send: SinglePlayer.mockSend };
                Host.handleData(mockConn, { type, val });
            }
        };

        const Game = {
            isHost: false, isSinglePlayer: false,
            host: () => { Game.isHost = true; Game.isSinglePlayer = false; Host.init(); },
            joinMenu: () => {
                const params = new URLSearchParams(location.search);
                if(params.get('code')) document.getElementById('join-code').value = params.get('code');
                UI.show('screen-join');
            }
        };

        const Host = {
            peer: null, code: '', players: [],
            state: { round: 1, stability: 100, phase: 'LOBBY', churns: 0, votes: {}, phaseItem: '', powerActive: false },

            init: (silent = false) => {
                if(!silent) {
                    Host.code = Math.random().toString(36).substring(2,6).toUpperCase();
                    UI.show('screen-host');
                    document.getElementById('host-code').innerText = Host.code;
                    new QRCode(document.getElementById('qrcode'), { text: location.href.split('?')[0] + "?code=" + Host.code, width: 128, height: 128 });
                    Host.peer = new Peer("sm-host-" + Host.code);
                    Host.peer.on('connection', conn => { conn.on('data', data => Host.handleData(conn, data)); });
                }
            },

            handleData: (conn, data) => {
                if(data.type === 'JOIN') {
                    const p = { id: conn.peer, name: data.name, conn: conn, role: null, powerUsed: false };
                    Host.players.push(p); Host.updateLobby(); conn.send({ type: 'WELCOME' });
                }
                else if(data.type === 'CHURN') {
                    Host.state.churns++; Host.broadcast({ type: 'FX_CHURN' });
                }
                else if(data.type === 'VOTE') {
                    Host.state.votes[conn.peer] = data.val;
                    if(Game.isSinglePlayer && conn.peer === 'human') {
                        // Trigger AI Sequence
                        AIEngine.startVotingSequence(Host);
                    } else if (!Game.isSinglePlayer) {
                        if(Object.keys(Host.state.votes).length >= Host.players.length) Host.resolveRound();
                    }
                }
                else if(data.type === 'POWER') {
                    const p = Host.players.find(pl => pl.id === conn.peer);
                    if(p && !p.powerUsed) {
                        p.powerUsed = true;
                        if(!Host.state.powers) Host.state.powers = {};
                        Host.state.powers[conn.peer] = 'DOUBLE_VOTE';
                        conn.send({ type: 'TOAST', msg: 'Divine Power Activated! Vote Weight x2' });
                    }
                }
            },

            updateLobby: () => {
                const list = document.getElementById('player-list');
                list.innerHTML = Host.players.map(p => `<div style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.05);">✦ ${p.name}</div>`).join('');
                document.getElementById('start-btn').disabled = Host.players.length < 1;
                document.getElementById('start-btn').innerText = Host.players.length < 2 ? "Waiting..." : "Begin";
            },

            start: () => {
                const total = Host.players.length;
                // --- FIX: ROBUST FISHER-YATES ---
                // Always ensure exactly 1 Asura if total players is small (<=4), else 30%
                let asuraCount = Math.max(1, Math.floor(total / 3));
                let roles = Array(asuraCount).fill('Asura').concat(Array(total - asuraCount).fill('Deva'));

                // Shuffle
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }

                Host.players.forEach((p, i) => {
                    p.role = roles[i];
                    p.conn.send({ type: 'ROLE', role: p.role, desc: p.role === 'Deva' ? 'Guardian of Light' : 'Agent of Chaos', secret: p.role === 'Asura' ? 'Goal: Crash Stability.' : 'Goal: Preserve Balance.' });
                });
                Host.nextRound();
            },

            broadcast: (msg) => Host.players.forEach(p => p.conn.send(msg)),

            nextRound: () => {
                Host.state.churns = 0; Host.state.votes = {}; Host.state.powers = {};
                Host.broadcast({ type: 'PHASE', name: 'CHURN', msg: 'Tap vigorously!', round: Host.state.round, stability: Host.state.stability });
                setTimeout(() => {
                    if(Game.isSinglePlayer) Host.state.churns += AIEngine.simulateChurn();
                    Host.phaseVote();
                }, 10000);
            },

            phaseVote: () => {
                let difficultyMod = 1.0;
                if(Host.state.stability > 80) difficultyMod = 1.2;
                if(Host.state.stability < 40) difficultyMod = 0.8;

                const threshold = (Host.players.length * 30) * difficultyMod; 
                const success = Host.state.churns > threshold;

                let item = "";
                if (!success) item = "Halahala (Poison)";
                else {
                    const r = Host.state.round;
                    if(Host.state.stability < 30) item = "Kamadhenu (Cow)";
                    else if (r === 1 || r === 4) item = "Kamadhenu (Cow)";
                    else if (r === 2 || r === 5) item = "Airavata (Elephant)";
                    else if (r === 3 || r === 7) item = "Amrita (Nectar)";
                    else item = "Halahala (Poison)";
                }
                Host.state.phaseItem = item;
                Host.broadcast({ type: 'PHASE', name: 'VOTE', msg: `Emerged: ${item}`, item: item });
            },

            resolveRound: () => {
                let keepCount = 0; let discardCount = 0; let voteList = [];
                Host.players.forEach(p => {
                    const choice = Host.state.votes[p.id];
                    let weight = 1;
                    if(Host.state.powers && Host.state.powers[p.id] === 'DOUBLE_VOTE') weight = 2;
                    if(choice) keepCount += weight; else discardCount += weight;
                    voteList.push({ name: p.name, choice: choice, weight: weight });
                });

                const majority = keepCount >= discardCount;
                let msg = ""; let impact = 0;
                const item = Host.state.phaseItem;

                if(majority) {
                    if(item.includes("Poison")) { msg = "Poison Kept! Stability -30"; impact = -30; }
                    else if(item.includes("Amrita")) { msg = "AMRITA SECURED!"; impact = 100; }
                    else { msg = "Blessing Kept! Stability +10"; impact = 10; }
                } else {
                    if(item.includes("Poison")) { msg = "Poison Discarded."; impact = 0; }
                    else if(item.includes("Amrita")) { msg = "AMRITA LOST! Stability -50"; impact = -50; }
                    else { msg = "Blessing Lost. Stability -10"; impact = -10; }
                }

                Host.state.stability += impact;
                if(Host.state.stability > 100) Host.state.stability = 100;

                Host.broadcast({ type: 'RESULT', msg: msg, stability: Host.state.stability, voteList: voteList });
                Host.state.round++;

                if(Host.state.stability <= 0 || impact === 100 || Host.state.round > 7) {
                    let endMsg = (impact === 100) ? "Devas Win! Immortality!" : "Asuras Win! Chaos!";
                    if (Host.state.round > 7) endMsg = "Balance Preserved.";
                    setTimeout(() => Host.broadcast({ type: 'GAMEOVER', msg: endMsg }), 6000);
                } else {
                    setTimeout(Host.nextRound, 6000);
                }
            }
        };

        const Client = {
            peer: null, conn: null, powerUsed: false,
            connect: () => {
                const name = document.getElementById('join-name').value || 'Soul';
                const code = document.getElementById('join-code').value.toUpperCase();
                if(!code) return UI.toast("Code Required");
                UI.toast("Connecting...");
                Client.peer = new Peer();
                Client.peer.on('open', id => {
                    const conn = Client.peer.connect("sm-host-" + code);
                    Client.conn = conn;
                    conn.on('open', () => { conn.send({ type: 'JOIN', name: name }); });
                    conn.on('data', Client.handleData);
                    conn.on('error', () => UI.toast("Host Not Found"));
                });
            },

            handleData: (data) => {
                if(data.type === 'WELCOME') UI.toast("Connected");
                else if(data.type === 'TOAST') UI.toast(data.msg);
                else if(data.type === 'VOTE_UPDATE') {
                    const statusArea = document.getElementById('thinking-area');
                    if(statusArea) {
                        statusArea.innerHTML = `<span>${data.msg}</span> <div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div>`;
                        if(data.done) AudioFX.play('tap');
                    }
                }
                else if(data.type === 'ROLE') {
                    document.getElementById('role-name').innerText = data.role;
                    document.getElementById('role-desc').innerText = data.desc;
                    document.getElementById('role-secret').innerText = data.secret;
                    const img = document.getElementById('role-img');
                    if(data.role === 'Asura') img.classList.add('asura-crop'); else img.classList.remove('asura-crop');
                    UI.show('screen-role');
                }
                else if(data.type === 'PHASE') {
                    UI.show('screen-play');
                    document.getElementById('phase-name').innerText = data.name;
                    document.getElementById('phase-msg').innerText = data.msg;
                    document.getElementById('round-val').innerText = data.round || '-';
                    document.getElementById('stability-val').innerText = (data.stability || 100) + '%';
                    const content = document.getElementById('game-content');
                    if(data.name === 'CHURN') {
                        content.innerHTML = `<div class="churn-container"><div class="churn-mask"><img src="./mount_mandara_churn.png" id="churn-dial" onerror="this.style.display='none'"></div><div class="tap-hint">TAP</div></div>`;
                        const dial = document.querySelector('.churn-container');
                        const h = (e) => { if(e.cancelable) e.preventDefault(); Client.churn(); };
                        dial.addEventListener('mousedown', h); dial.addEventListener('touchstart', h);
                    } 
                    else if(data.name === 'VOTE') {
                        const iconClass = UI.getIconClass(data.item);
                        const powerBtn = !Client.powerUsed ? `<button class="btn btn-power" onclick="Client.usePower(this)">⚡ Invoke Power (1x)</button>` : `<button class="btn btn-power" disabled>Power Used</button>`;
                        content.innerHTML = `
                            <div class="treasure-frame"><img src="./treasures_icons.png" class="icon-sprite ${iconClass}" onerror="this.style.display='none'"></div>
                            ${powerBtn}
                            <div id="thinking-area" class="thinking-area"></div>
                            <div id="vote-controls" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%;">
                                <button class="btn btn-primary" onclick="Client.vote(true)">Keep</button>
                                <button class="btn btn-danger" onclick="Client.vote(false)">Discard</button>
                            </div>`;
                    }
                    AudioFX.play('alert');
                }
                else if(data.type === 'FX_CHURN') {
                    const dial = document.getElementById('churn-dial');
                    if(dial) dial.style.transform = `rotate(${Math.random()*360}deg) scale(${1 + Math.random()*0.1})`;
                }
                else if(data.type === 'RESULT') {
                    document.getElementById('phase-name').innerText = "COUNCIL DECISION";
                    document.getElementById('phase-msg').innerText = data.msg;
                    document.getElementById('stability-val').innerText = data.stability + '%';
                    let keepHtml = ''; let discardHtml = '';
                    data.voteList.forEach(v => {
                        const powerIcon = v.weight > 1 ? '⚡' : '';
                        const row = `<div class="vote-item"><div class="vote-dot ${v.choice ? 'dot-green' : 'dot-red'}"></div>${v.name} ${powerIcon}</div>`;
                        if(v.choice) keepHtml += row; else discardHtml += row;
                    });
                    document.getElementById('game-content').innerHTML = `
                        <div class="vote-results">
                            <div class="vote-col"><h3 style="color:var(--color-green)">KEEP</h3>${keepHtml || '<div style="opacity:0.5; font-size:0.8rem">None</div>'}</div>
                            <div class="vote-col"><h3 style="color:var(--color-red)">DISCARD</h3>${discardHtml || '<div style="opacity:0.5; font-size:0.8rem">None</div>'}</div>
                        </div>`;
                }
                else if(data.type === 'GAMEOVER') {
                    document.getElementById('phase-name').innerText = "GAME OVER";
                    document.getElementById('phase-msg').innerText = data.msg;
                    document.getElementById('game-content').innerHTML = `<button class="btn" onclick="location.reload()">Reincarnate</button>`;
                }
            },

            churn: () => {
                if(Game.isSinglePlayer) SinglePlayer.humanAction('CHURN');
                else Client.conn.send({ type: 'CHURN' });
                AudioFX.play('tap'); if(navigator.vibrate) navigator.vibrate(15);
            },

            vote: (val) => {
                if(Game.isSinglePlayer) SinglePlayer.humanAction('VOTE', val);
                else Client.conn.send({ type: 'VOTE', val: val });
                document.getElementById('vote-controls').style.opacity = '0.5';
                document.getElementById('vote-controls').style.pointerEvents = 'none';
                document.getElementById('thinking-area').innerText = 'Waiting for Council...';
            },

            usePower: (btn) => {
                Client.powerUsed = true;
                btn.innerText = "Power Active!";
                btn.disabled = true;
                AudioFX.play('power');
                if(Game.isSinglePlayer) SinglePlayer.humanAction('POWER');
                else Client.conn.send({ type: 'POWER' });
            }
        };

        const Cosmos = {
            init: () => {
                const c = document.getElementById('cosmos-canvas');
                const x = c.getContext('2d');
                let w, h;
                const stars = Array(80).fill().map(() => ({ x:Math.random(), y:Math.random(), s:Math.random()*2, a:Math.random() }));
                const resize = () => { w=c.width=innerWidth; h=c.height=innerHeight; };
                window.onresize = resize; resize();
                const loop = () => {
                    x.clearRect(0,0,w,h);
                    stars.forEach(s => {
                        s.y -= s.s * 0.0005; if(s.y<0) s.y=1;
                        x.fillStyle = `rgba(255,255,255,${s.a})`;
                        x.beginPath(); x.arc(s.x*w, s.y*h, s.s, 0, Math.PI*2); x.fill();
                    });
                    requestAnimationFrame(loop);
                };
                loop();
            }
        };
        Cosmos.init();

    </script>
</body>
</html>
